name: Daily Backup

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 12:00 UTC (15:00 –ú–°–ö)
    - cron: '0 12 * * *'
  workflow_dispatch: # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞ –≤—Ä—É—á–Ω—É—é

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
    
    - name: Set backup date
      run: |
        echo "BACKUP_DATE=$(date +'%Y-%m-%d-%H%M')" >> $GITHUB_ENV
        echo "BACKUP_BRANCH=backup-$(date +'%Y-%m-%d')" >> $GITHUB_ENV
    
    - name: Create backup info
      run: |
        mkdir -p backup-info
        echo "# Health Supplements Hub Backup" > backup-info/README.md
        echo "Backup created: $(date)" >> backup-info/README.md
        echo "Repository: ${{ github.repository }}" >> backup-info/README.md
        echo "Commit: ${{ github.sha }}" >> backup-info/README.md
        echo "" >> backup-info/README.md
        echo "## Files included:" >> backup-info/README.md
        find . -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.yml" -o -name "*.xml" -o -name "*.txt" | grep -v ".git" | sort >> backup-info/README.md
        echo "" >> backup-info/README.md
        echo "## Statistics:" >> backup-info/README.md
        echo "Total HTML pages: $(find . -name "*.html" | wc -l)" >> backup-info/README.md
        echo "Total files: $(find . -type f | grep -v ".git" | wc -l)" >> backup-info/README.md
    
    - name: Create backup archive
      run: |
        tar -czf health-supplements-hub-backup-${{ env.BACKUP_DATE }}.tar.gz \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='*.tar.gz' \
          .
        
        # –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞
        ls -lh health-supplements-hub-backup-${{ env.BACKUP_DATE }}.tar.gz
    
    - name: Create backup branch
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ç–∫—É –¥–ª—è –±–µ–∫–∞–ø–∞
        git checkout -b ${{ env.BACKUP_BRANCH }}
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–µ–∫–∞–ø–µ
        git add backup-info/
        git commit -m "üì¶ Daily backup - ${{ env.BACKUP_DATE }}"
        
        # –ü—É—à–∏–º –≤–µ—Ç–∫—É
        git push origin ${{ env.BACKUP_BRANCH }}
    
    - name: Create Release with backup
      uses: softprops/action-gh-release@v1
      with:
        tag_name: backup-${{ env.BACKUP_DATE }}
        name: "Daily Backup - ${{ env.BACKUP_DATE }}"
        body: |
          üîÑ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–µ–∫–∞–ø**
          
          üìÖ **–î–∞—Ç–∞:** ${{ env.BACKUP_DATE }}
          üè∑Ô∏è **–ö–æ–º–º–∏—Ç:** ${{ github.sha }}
          
          üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
          - HTML —Å—Ç—Ä–∞–Ω–∏—Ü: 24
          - –í—Å–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
          - –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è Git
          
          üíæ **–í–∫–ª—é—á–µ–Ω–æ:**
          - –í—Å–µ HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          - CSS/JS —Ñ–∞–π–ª—ã  
          - GitHub Actions
          - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
          
          üîó **–í–µ—Ç–∫–∞ –±–µ–∫–∞–ø–∞:** `${{ env.BACKUP_BRANCH }}`
        files: |
          health-supplements-hub-backup-${{ env.BACKUP_DATE }}.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Cleanup old backup branches
      run: |
        # –£–¥–∞–ª—è–µ–º –≤–µ—Ç–∫–∏ –±–µ–∫–∞–ø–æ–≤ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π
        git branch -r | grep 'origin/backup-' | sed 's/origin\///' | while read branch; do
          branch_date=$(echo $branch | sed 's/backup-//')
          if [ $(date -d "$branch_date" +%s 2>/dev/null || echo 0) -lt $(date -d "30 days ago" +%s) ]; then
            echo "–£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ç–∫—É: $branch"
            git push origin --delete $branch || echo "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å $branch"
          fi
        done
    
    - name: Summary
      run: |
        echo "‚úÖ –ë–µ–∫–∞–ø —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
        echo "üì¶ –ê—Ä—Ö–∏–≤: health-supplements-hub-backup-${{ env.BACKUP_DATE }}.tar.gz"
        echo "üåø –í–µ—Ç–∫–∞: ${{ env.BACKUP_BRANCH }}"
        echo "üè∑Ô∏è –†–µ–ª–∏–∑: backup-${{ env.BACKUP_DATE }}"
        echo "‚è∞ –°–ª–µ–¥—É—é—â–∏–π –±–µ–∫–∞–ø: –∑–∞–≤—Ç—Ä–∞ –≤ 12:00 UTC"
