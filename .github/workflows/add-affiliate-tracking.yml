name: Add Affiliate Tracking Script

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all pages (even if already have script)'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [ main ]
    paths:
      - '**/*.html'

jobs:
  add-affiliate-tracking:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Add affiliate tracking script to HTML pages
      run: |
        echo "üöÄ Starting affiliate tracking script addition..."
        
        # –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        updated_count=0
        skipped_count=0
        total_count=0
        
        # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞
        add_affiliate_script() {
            local file="$1"
            local script_path="$2"
            
            echo "Processing $file..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ affiliate tracking script
            if grep -q "affiliate-tracking.js" "$file"; then
                if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
                    echo "  ‚Üª Force updating $file"
                    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Å–∫—Ä–∏–ø—Ç
                    sed -i '/affiliate-tracking\.js/d' "$file"
                else
                    echo "  ‚è≠Ô∏è  Skipping $file (already has affiliate tracking)"
                    return 1
                fi
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ </body>
            if ! grep -q "</body>" "$file"; then
                echo "  ‚ö†Ô∏è  Warning: No </body> tag found in $file"
                return 1
            fi
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–º —Ç–µ–≥–æ–º </body>
            sed -i "s|</body>|    <script src=\"$script_path\"></script>\n</body>|" "$file"
            
            echo "  ‚úÖ Added affiliate tracking to $file"
            return 0
        }
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º HTML —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–Ω–µ
        for file in *.html; do
            if [ -f "$file" ]; then
                total_count=$((total_count + 1))
                if add_affiliate_script "$file" "affiliate-tracking.js"; then
                    updated_count=$((updated_count + 1))
                else
                    skipped_count=$((skipped_count + 1))
                fi
            fi
        done
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º HTML —Ñ–∞–π–ª—ã –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö
        for dir in */; do
            if [ -d "$dir" ]; then
                for file in "$dir"*.html; do
                    if [ -f "$file" ]; then
                        total_count=$((total_count + 1))
                        if add_affiliate_script "$file" "../affiliate-tracking.js"; then
                            updated_count=$((updated_count + 1))
                        else
                            skipped_count=$((skipped_count + 1))
                        fi
                    fi
                done
            fi
        done
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º index.html —Ñ–∞–π–ª—ã –≤ –ø–æ–¥–ø–∞–ø–∫–∞—Ö
        for dir in */; do
            if [ -d "$dir" ] && [ -f "${dir}index.html" ]; then
                file="${dir}index.html"
                total_count=$((total_count + 1))
                if add_affiliate_script "$file" "../affiliate-tracking.js"; then
                    updated_count=$((updated_count + 1))
                else
                    skipped_count=$((skipped_count + 1))
                fi
            fi
        done
        
        # –í—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        echo ""
        echo "üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø:"
        echo "  üìÑ –í—Å–µ–≥–æ HTML —Ñ–∞–π–ª–æ–≤: $total_count"
        echo "  ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: $updated_count"
        echo "  ‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ: $skipped_count"
        echo ""
        
        if [ $updated_count -gt 0 ]; then
            echo "üéØ Affiliate tracking script —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ $updated_count —Å—Ç—Ä–∞–Ω–∏—Ü!"
        else
            echo "‚ÑπÔ∏è  –í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–∂–µ –∏–º–µ—é—Ç affiliate tracking script"
        fi
        
    - name: Verify affiliate tracking implementation
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ affiliate tracking..."
        
        # –ò—â–µ–º —Ñ–∞–π–ª—ã —Å affiliate tracking
        files_with_tracking=$(find . -name "*.html" -exec grep -l "affiliate-tracking.js" {} \;)
        count=$(echo "$files_with_tracking" | wc -l)
        
        echo "üìã –§–∞–π–ª—ã —Å affiliate tracking script:"
        echo "$files_with_tracking"
        echo ""
        echo "‚úÖ –í—Å–µ–≥–æ —Ñ–∞–π–ª–æ–≤ —Å affiliate tracking: $count"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ affiliate-tracking.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if [ -f "affiliate-tracking.js" ]; then
            echo "‚úÖ affiliate-tracking.js file exists"
        else
            echo "‚ùå affiliate-tracking.js file not found!"
            exit 1
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        
        if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
        else
            echo "üíæ Committing changes..."
            git commit -m "Add affiliate tracking script to HTML pages

            - Automatically added affiliate-tracking.js to all HTML files
            - Script will track DigitalStore24 partner links
            - Sends click_affiliate events to GA4
            - Auto-run: $(date)"
            git push
            echo "üöÄ Changes committed and pushed successfully!"
        fi
