name: Fix Security Headers

on:
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  fix-security-headers:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Remove old Security Headers and add complete set
      run: |
        echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º Security Headers..."
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä Security Headers
        cat > security_headers_complete.txt << 'EOF'
        <!-- Security Headers -->
        <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
        <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://googleads.g.doubleclick.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://www.google-analytics.com https://www.googletagmanager.com; connect-src 'self' https://www.google-analytics.com https://analytics.google.com https://www.digistore24.com; frame-src 'none';">
        <meta http-equiv="X-Frame-Options" content="DENY">
        <meta http-equiv="X-Content-Type-Options" content="nosniff">
        <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
        <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
        <meta http-equiv="X-XSS-Protection" content="1; mode=block">
        EOF
        
        PROCESSED=0
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ HTML —Ñ–∞–π–ª—ã
        for file in *.html; do
          if [ -f "$file" ]; then
            echo "üìÑ –ò—Å–ø—Ä–∞–≤–ª—è–µ–º: $file"
            
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ Security Headers
            sed '/<!-- Security Headers -->/,/X-XSS-Protection/d' "$file" > "${file}.tmp1"
            
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø–æ–ª–Ω—ã–µ Security Headers
            awk '
            /^[[:space:]]*<\/head>/ {
              while ((getline line < "security_headers_complete.txt") > 0) {
                print "    " line
              }
              close("security_headers_complete.txt")
            }
            { print }
            ' "${file}.tmp1" > "${file}.tmp2"
            
            mv "${file}.tmp2" "$file"
            rm -f "${file}.tmp1"
            
            echo "   ‚úÖ Security Headers –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
            PROCESSED=$((PROCESSED + 1))
          fi
        done
        
        rm -f security_headers_complete.txt
        
        echo ""
        echo "üìä –û–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: $PROCESSED"
        echo "üîí –î–æ–±–∞–≤–ª–µ–Ω Strict-Transport-Security!"
    
    - name: Force cache busting
      run: |
        echo "üîÑ –î–æ–±–∞–≤–ª—è–µ–º cache-busting –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏..."
        
        # –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫–µ—à–∞
        TIMESTAMP=$(date +%s)
        
        for file in *.html; do
          if [ -f "$file" ]; then
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å timestamp –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞
            echo "<!-- Cache bust: $TIMESTAMP -->" > "${file}.tmp"
            cat "$file" >> "${file}.tmp"
            mv "${file}.tmp" "$file"
            echo "   üîÑ Cache-bust –¥–æ–±–∞–≤–ª–µ–Ω –≤ $file"
          fi
        done
    
    - name: Verify all Security Headers
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ü–û–õ–ù–´–ô –Ω–∞–±–æ—Ä Security Headers..."
        echo ""
        
        for file in *.html; do
          if [ -f "$file" ]; then
            echo "üìÑ $file:"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï headers –≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–π HSTS
            if grep -q "Strict-Transport-Security" "$file"; then
              echo "   ‚úÖ Strict-Transport-Security"
            else
              echo "   ‚ùå Strict-Transport-Security –ù–ï –ù–ê–ô–î–ï–ù"
            fi
            
            if grep -q "Content-Security-Policy" "$file"; then
              echo "   ‚úÖ Content-Security-Policy"
            else
              echo "   ‚ùå Content-Security-Policy –ù–ï –ù–ê–ô–î–ï–ù"
            fi
            
            if grep -q "X-Frame-Options" "$file"; then
              echo "   ‚úÖ X-Frame-Options"
            else
              echo "   ‚ùå X-Frame-Options –ù–ï –ù–ê–ô–î–ï–ù"
            fi
            
            if grep -q "X-Content-Type-Options" "$file"; then
              echo "   ‚úÖ X-Content-Type-Options"
            else
              echo "   ‚ùå X-Content-Type-Options –ù–ï –ù–ê–ô–î–ï–ù"
            fi
            
            if grep -q "Referrer-Policy" "$file"; then
              echo "   ‚úÖ Referrer-Policy"
            else
              echo "   ‚ùå Referrer-Policy –ù–ï –ù–ê–ô–î–ï–ù"
            fi
            
            if grep -q "Permissions-Policy" "$file"; then
              echo "   ‚úÖ Permissions-Policy"
            else
              echo "   ‚ùå Permissions-Policy –ù–ï –ù–ê–ô–î–ï–ù"
            fi
            
            echo ""
          fi
        done
    
    - name: Commit changes
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        git add *.html
        git commit -m "üîí Fix Security Headers - add HSTS and cache busting

        - –î–æ–±–∞–≤–ª–µ–Ω Strict-Transport-Security (HSTS)
        - –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ Security Headers
        - –î–æ–±–∞–≤–ª–µ–Ω cache-busting –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Content-Security-Policy –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏"
        
        git push
        echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!"
    
    - name: Summary
      run: |
        echo "üéâ Security Headers –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã!"
        echo ""
        echo "üîí –ü–û–õ–ù–´–ô –Ω–∞–±–æ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤:"
        echo "   ‚Ä¢ Strict-Transport-Security (HSTS) - –î–û–ë–ê–í–õ–ï–ù"
        echo "   ‚Ä¢ Content-Security-Policy (–æ–±–Ω–æ–≤–ª–µ–Ω)"
        echo "   ‚Ä¢ X-Frame-Options: DENY"  
        echo "   ‚Ä¢ X-Content-Type-Options: nosniff"
        echo "   ‚Ä¢ Referrer-Policy: strict-origin-when-cross-origin"
        echo "   ‚Ä¢ Permissions-Policy"
        echo "   ‚Ä¢ X-XSS-Protection"
        echo ""
        echo "üîÑ Cache-busting –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
        echo "üß™ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –æ—á–∏—Å—Ç–∏—Ç–µ Cloudflare –∫–µ—à!"
        echo "üåê –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ç–µ—Å—Ç —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç"
