name: Auto-generate Sitemap + Check Favicon

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  update-site:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Update sitemap and check favicon
      run: |
        cat > update_site.py << 'EOF'
        #!/usr/bin/env python3
        """
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ sitemap + –ø—Ä–æ–≤–µ—Ä–∫–∞ favicon –≤–æ –≤—Å–µ—Ö HTML
        """
        
        import os
        import datetime
        import re
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        SITE_URL = "https://www.danilichev.info"
        
        # HTML –∫–æ–¥ –¥–ª—è favicon
        FAVICON_HTML = '''    <!-- Favicon -->
        <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
        <meta name="apple-mobile-web-app-title" content="Health Supplements Hub" />
        <link rel="manifest" href="/site.webmanifest" />'''
        
        def generate_sitemap():
            """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç sitemap.xml"""
            today = datetime.date.today().strftime('%Y-%m-%d')
            
            # –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü
            pages = [
                {'url': '/', 'priority': '1.0', 'changefreq': 'weekly'},
                {'url': '/advanced-mitochondrial-formula/', 'priority': '0.95', 'changefreq': 'monthly'},
                {'url': '/health-supplements/', 'priority': '0.9', 'changefreq': 'weekly'},
                {'url': '/health-products/', 'priority': '0.9', 'changefreq': 'weekly'},
                {'url': '/anti-aging-hacks/', 'priority': '0.9', 'changefreq': 'weekly'},
                {'url': '/brain-supplements/', 'priority': '0.9', 'changefreq': 'weekly'},
                {'url': '/weight-loss-supplements/', 'priority': '0.9', 'changefreq': 'weekly'},
                {'url': '/mitochondrial-energy-guide/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/why-always-tired-after-40/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/afternoon-energy-crash-solutions/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/brain-fog-after-40-causes/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/chronic-fatigue-not-aging/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/low-energy-warning-signs/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/nad-decline-after-40-effects/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/mitochondrial-dysfunction-aging-process/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/cellular-energy-production-slowdown/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/mitochondrial-supplements-research/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/best-energy-supplements-after-40/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/nad-boosting-supplements-comparison/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/natural-energy-restoration-methods/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/mens-fatigue-solutions-over-40/', 'priority': '0.8', 'changefreq': 'monthly'},
            ]
            
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
            for root, dirs, files in os.walk('.'):
                dirs[:] = [d for d in dirs if not d.startswith('.')]
                if root == '.':
                    continue
                
                if 'index.html' in files:
                    dir_path = os.path.relpath(root, '.')
                    url_path = '/' + dir_path.replace('\\', '/') + '/'
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ
                    if not any(page['url'] == url_path for page in pages):
                        print(f"üÜï –ù–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞: {url_path}")
                        pages.append({
                            'url': url_path,
                            'priority': '0.8',
                            'changefreq': 'monthly'
                        })
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º XML
            xml_content = '''<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9
        http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd">
'''
            
            pages_sorted = sorted(pages, key=lambda x: float(x['priority']), reverse=True)
            
            for page in pages_sorted:
                full_url = SITE_URL + page['url']
                xml_content += f'''
    <url>
        <loc>{full_url}</loc>
        <lastmod>{today}</lastmod>
        <changefreq>{page['changefreq']}</changefreq>
        <priority>{page['priority']}</priority>
    </url>'''
            
            xml_content += '''

</urlset>'''
            
            with open('sitemap.xml', 'w', encoding='utf-8') as f:
                f.write(xml_content)
            
            print(f"‚úÖ Sitemap –æ–±–Ω–æ–≤–ª–µ–Ω ({len(pages)} —Å—Ç—Ä–∞–Ω–∏—Ü)")
        
        def check_and_add_favicon():
            """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç favicon –≤–æ –≤—Å–µ HTML —Ñ–∞–π–ª—ã"""
            updated_files = []
            
            for root, dirs, files in os.walk('.'):
                dirs[:] = [d for d in dirs if not d.startswith('.')]
                
                for file in files:
                    if file.endswith('.html'):
                        file_path = os.path.join(root, file)
                        
                        try:
                            with open(file_path, 'r', encoding='utf-8') as f:
                                content = f.read()
                            
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ favicon
                            if 'favicon' in content.lower() or 'apple-touch-icon' in content.lower():
                                continue
                            
                            if '</head>' not in content:
                                continue
                            
                            # –î–æ–±–∞–≤–ª—è–µ–º favicon
                            new_content = content.replace('</head>', f'{FAVICON_HTML}\n</head>')
                            
                            with open(file_path, 'w', encoding='utf-8') as f:
                                f.write(new_content)
                            
                            updated_files.append(file_path)
                            print(f"üé® Favicon –¥–æ–±–∞–≤–ª–µ–Ω: {file_path}")
                            
                        except Exception as e:
                            print(f"‚ùå –û—à–∏–±–∫–∞ –≤ {file_path}: {e}")
            
            if updated_files:
                print(f"‚úÖ Favicon –¥–æ–±–∞–≤–ª–µ–Ω –≤ {len(updated_files)} —Ñ–∞–π–ª–æ–≤")
            else:
                print("‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã —É–∂–µ —Å–æ–¥–µ—Ä–∂–∞—Ç favicon")
        
        def main():
            """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
            print("üöÄ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∞–π—Ç–∞...")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º sitemap
            generate_sitemap()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º favicon
            check_and_add_favicon()
            
            print("‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
        
        if __name__ == "__main__":
            main()
        EOF
        
        python update_site.py
    
    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "üìã –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "üîÑ –ï—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
        fi
    
    - name: Commit updates
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        git add -A
        git commit -m "ü§ñ Auto-update: sitemap + favicon check - $(date '+%Y-%m-%d %H:%M:%S')"
        git push
        echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!"
    
    - name: No changes message
      if: steps.check_changes.outputs.changed == 'false'
      run: |
        echo "‚ÑπÔ∏è –°–∞–π—Ç –∞–∫—Ç—É–∞–ª–µ–Ω, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è"
