name: Auto-generate Sitemap

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  generate-sitemap:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Create sitemap generator script
      run: |
        cat > generate_sitemap.py << 'EOF'
        #!/usr/bin/env python3
        """
        –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä sitemap.xml –¥–ª—è Health Supplements Hub
        """
        
        import os
        import datetime
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        SITE_URL = "https://www.danilichev.info"
        
        def main():
            """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ sitemap"""
            today = datetime.date.today().strftime('%Y-%m-%d')
            
            # –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ URL
            pages = [
                # –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
                {'url': '/', 'priority': '1.0', 'changefreq': 'weekly'},
                
                # –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–π –ª–µ–Ω–¥–∏–Ω–≥
                {'url': '/advanced-mitochondrial-formula/', 'priority': '0.95', 'changefreq': 'monthly'},
                
                # –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
                {'url': '/health-supplements/', 'priority': '0.9', 'changefreq': 'weekly'},
                {'url': '/health-products/', 'priority': '0.9', 'changefreq': 'weekly'},
                {'url': '/anti-aging-hacks/', 'priority': '0.9', 'changefreq': 'weekly'},
                {'url': '/brain-supplements/', 'priority': '0.9', 'changefreq': 'weekly'},
                {'url': '/weight-loss-supplements/', 'priority': '0.9', 'changefreq': 'weekly'},
                
                # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–µ –ª–µ–Ω–¥–∏–Ω–≥)
                {'url': '/mitochondrial-energy-guide/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/why-always-tired-after-40/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/afternoon-energy-crash-solutions/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/brain-fog-after-40-causes/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/chronic-fatigue-not-aging/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/low-energy-warning-signs/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/nad-decline-after-40-effects/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/mitochondrial-dysfunction-aging-process/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/cellular-energy-production-slowdown/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/mitochondrial-supplements-research/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/best-energy-supplements-after-40/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/nad-boosting-supplements-comparison/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/natural-energy-restoration-methods/', 'priority': '0.8', 'changefreq': 'monthly'},
                {'url': '/mens-fatigue-solutions-over-40/', 'priority': '0.8', 'changefreq': 'monthly'},
            ]
            
            print(f"üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è sitemap –¥–ª—è {len(pages)} —Å—Ç—Ä–∞–Ω–∏—Ü:")
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º XML
            xml_content = '''<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9
        http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd">
'''
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–≤—ã—Å–æ–∫–∏–π -> –Ω–∏–∑–∫–∏–π)
            pages_sorted = sorted(pages, key=lambda x: float(x['priority']), reverse=True)
            
            for page in pages_sorted:
                full_url = SITE_URL + page['url']
                print(f"  - {full_url} (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {page['priority']})")
                
                xml_content += f'''
    <url>
        <loc>{full_url}</loc>
        <lastmod>{today}</lastmod>
        <changefreq>{page['changefreq']}</changefreq>
        <priority>{page['priority']}</priority>
    </url>'''
            
            xml_content += '''

</urlset>'''
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª
            with open('sitemap.xml', 'w', encoding='utf-8') as f:
                f.write(xml_content)
            
            print("‚úÖ Sitemap —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!")
            print(f"üåê URL: {SITE_URL}/sitemap.xml")
        
        if __name__ == "__main__":
            main()
        EOF
    
    - name: Generate sitemap
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ sitemap..."
        python generate_sitemap.py
        
    - name: Check if sitemap changed
      id: check_changes
      run: |
        if git diff --quiet sitemap.xml; then
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "üìã Sitemap –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è"
        else
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "üîÑ Sitemap –æ–±–Ω–æ–≤–ª–µ–Ω"
        fi
    
    - name: Commit and push sitemap
      if: steps.check_changes.outputs.changed == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        git add sitemap.xml
        git commit -m "ü§ñ Fix sitemap URLs - remove /index/ - $(date '+%Y-%m-%d %H:%M:%S')"
        git push
        echo "‚úÖ Sitemap committed and pushed!"
    
    - name: No changes message
      if: steps.check_changes.outputs.changed == 'false'
      run: |
        echo "‚ÑπÔ∏è Sitemap –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è"
