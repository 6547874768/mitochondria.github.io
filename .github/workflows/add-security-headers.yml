name: Add Security Headers

on:
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    paths:
      - '*.html' # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ HTML —Ñ–∞–π–ª–æ–≤

jobs:
  add-security-headers:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Add Security Headers to HTML files
      run: |
        echo "üîí –î–æ–±–∞–≤–ª—è–µ–º Security Headers –≤ HTML —Ñ–∞–π–ª—ã..."
        
        # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å Security Headers
        cat > security_headers.txt << 'EOF'
        <!-- Security Headers -->
        <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://www.google-analytics.com; connect-src 'self' https://www.google-analytics.com https://www.digistore24.com;">
        <meta http-equiv="X-Frame-Options" content="DENY">
        <meta http-equiv="X-Content-Type-Options" content="nosniff">
        <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
        <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">
        <meta http-equiv="X-XSS-Protection" content="1; mode=block">
        EOF
        
        # –°—á–µ—Ç—á–∏–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        PROCESSED=0
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ HTML —Ñ–∞–π–ª—ã
        for file in *.html; do
          if [ -f "$file" ]; then
            echo "üìÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: $file"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ Security Headers
            if grep -q "Security Headers" "$file"; then
              echo "   ‚ö†Ô∏è  Security Headers —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            else
              # –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É —Å </head> –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –Ω–µ–π
              if grep -q "</head>" "$file"; then
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º awk –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏
                awk '
                /^[[:space:]]*<\/head>/ {
                  while ((getline line < "security_headers.txt") > 0) {
                    print "    " line
                  }
                  close("security_headers.txt")
                }
                { print }
                ' "$file" > "${file}.tmp"
                
                mv "${file}.tmp" "$file"
                echo "   ‚úÖ Security Headers –¥–æ–±–∞–≤–ª–µ–Ω—ã"
                PROCESSED=$((PROCESSED + 1))
              else
                echo "   ‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Ç–µ–≥ </head>"
              fi
            fi
          fi
        done
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        rm -f security_headers.txt
        
        echo ""
        echo "üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: $PROCESSED"
        echo "üîí Security Headers –¥–æ–±–∞–≤–ª–µ–Ω—ã!"
    
    - name: Verify Security Headers
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ Security Headers..."
        echo ""
        
        TOTAL_FILES=0
        HEADERS_OK=0
        
        for file in *.html; do
          if [ -f "$file" ]; then
            TOTAL_FILES=$((TOTAL_FILES + 1))
            echo "üìÑ $file:"
            
            CURRENT_HEADERS=0
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π header
            if grep -q "Content-Security-Policy" "$file"; then
              echo "   ‚úÖ Content-Security-Policy"
              CURRENT_HEADERS=$((CURRENT_HEADERS + 1))
            else
              echo "   ‚ùå Content-Security-Policy –ù–ï –ù–ê–ô–î–ï–ù"
            fi
            
            if grep -q "X-Frame-Options" "$file"; then
              echo "   ‚úÖ X-Frame-Options"
              CURRENT_HEADERS=$((CURRENT_HEADERS + 1))
            else
              echo "   ‚ùå X-Frame-Options –ù–ï –ù–ê–ô–î–ï–ù"
            fi
            
            if grep -q "X-Content-Type-Options" "$file"; then
              echo "   ‚úÖ X-Content-Type-Options"
              CURRENT_HEADERS=$((CURRENT_HEADERS + 1))
            else
              echo "   ‚ùå X-Content-Type-Options –ù–ï –ù–ê–ô–î–ï–ù"
            fi
            
            if grep -q "Referrer-Policy" "$file"; then
              echo "   ‚úÖ Referrer-Policy"
              CURRENT_HEADERS=$((CURRENT_HEADERS + 1))
            else
              echo "   ‚ùå Referrer-Policy –ù–ï –ù–ê–ô–î–ï–ù"
            fi
            
            if [ $CURRENT_HEADERS -eq 4 ]; then
              HEADERS_OK=$((HEADERS_OK + 1))
              echo "   üéâ –í—Å–µ headers –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç!"
            fi
            
            echo ""
          fi
        done
        
        echo "üìä –ò—Ç–æ–≥–æ: $HEADERS_OK –∏–∑ $TOTAL_FILES —Ñ–∞–π–ª–æ–≤ –∏–º–µ—é—Ç –≤—Å–µ Security Headers"
    
    - name: Commit changes
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        if git diff --quiet; then
          echo "üîÑ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          git add *.html
          git commit -m "üîí Add Security Headers to HTML files

          - Content-Security-Policy —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π GA4 –∏ DigitalStore24
          - X-Frame-Options: DENY
          - X-Content-Type-Options: nosniff  
          - Referrer-Policy: strict-origin-when-cross-origin
          - Permissions-Policy: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏/–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞/–∫–∞–º–µ—Ä—ã
          - X-XSS-Protection: –≤–∫–ª—é—á–µ–Ω–∞ –∑–∞—â–∏—Ç–∞"
          
          git push
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!"
        fi
    
    - name: Summary
      run: |
        echo "üéâ Security Headers —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã!"
        echo ""
        echo "üîí –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏:"
        echo "   ‚Ä¢ Content-Security-Policy (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π GA4/DigitalStore24)"
        echo "   ‚Ä¢ X-Frame-Options: DENY"  
        echo "   ‚Ä¢ X-Content-Type-Options: nosniff"
        echo "   ‚Ä¢ Referrer-Policy: strict-origin-when-cross-origin"
        echo "   ‚Ä¢ Permissions-Policy: geolocation/microphone/camera –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã"
        echo "   ‚Ä¢ X-XSS-Protection: –≤–∫–ª—é—á–µ–Ω–∞"
        echo ""
        echo "üß™ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: —Ç–µ—Å—Ç –Ω–∞ securityheaders.com"
        echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ: https://securityheaders.com/?q=danilichev.info"
